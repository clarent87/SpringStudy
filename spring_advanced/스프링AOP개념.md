# 스프링 AOP 개념

## AOP 소개 - 핵심 기능과 부가 기능

- 개요
  - AOP 개념의 필요성 소개

## AOP 소개 - 애스펙트 (3)

- 개요
  - 애스펙트 개념 소개

- 포인트
  - AOP는 OOP를 대체하기 위한 것이 아니라
  - 횡단 관심사를 깔끔하게 처리하기 어려운 OOP의 부족한 부분을 보조하는 목적으로 개발되었다.

- AspectJ 프레임워크
  - AOP의 대표적인 구현으로 AspectJ 프레임워크(<https://www.eclipse.org/aspectj/>)가 있다.
  - 물론 스프링도 AOP를 지원하지만 대부분 AspectJ의 문법을 차용하고,  AspectJ가 제공하는 기능의 일부만 제공한다.
    - > @Aspect AOP  강좌 및 앞선 강좌의 내용이 스프링 AOP였다.
  - > 여기서는 AspectJ 프레임워크 를 스프링에서 쓰고있다는 것이 아니라 AspectJ 프레임워크란 대표적인 프레임워크가 있고
  - > 스프링이 그걸 차용해서 기능을 제공한다.. 정도 내용임
  
즉 ApsectJ의 프레임워크는 기능이 엄~청 많은데 스프링은 그중 실무에서 많이 쓸만한 일부 기능을 차용해서 제공한다.
  
> 다음절에서 AspectJ 프레임워크 랑 spring aop의 차이를 좀더 설명할 예정.

## AOP 적용 방식

- 개요
  - AOP를 사용할 때 부가 기능 로직은 어떤 방식으로 실제 로직에 추가할수 있을지?
    - > 앞서 나온 proxy 패턴은 이 방식중 하나일 뿐이었네..

- AOP를 사용할 때 부가 기능 로직은 어떤 방식으로 실제 로직에 추가할수 있을지?
  - 크게 3가지 방법이 있다.
    - 컴파일 시점
      - > aspectj 프레임워크 같은것을 사용하면 사용할수 있는 방식
    - 클래스 로딩 시점
      - > ( java -javaagent ) 같은 세팅 이용.
    - 런타임 시점(프록시)
      - > 여지껏 알아본 방식
    - >위에서 컴파일 시점,클래스 로딩 시점은 번거롭고 복잡해서 잘안쓴다고함  
    - >근데 azure insight의 경우 클래스 로딩 시점 위빙을 이용한 방식이었음.  

- 런타임 시점(프록시) 단점
  - 프록시를 사용하기 때문에 AOP 기능에 일부 제약이 있다
    - final class/method에 적용 못함.
      - > final method 적용 못하는거 맞을듯..
    - constructor에는 적용 못함
    - > 즉 override되는 method에만 적용 가능.

- 중요 포인트
  - aspectj를 직접 이용하면 다양한 join point에 aop 적용가능
  - 하지만 프록시 방식을 사용하는 스프링 AOP는 메서드 실행 지점에만 AOP를 적용할 수 있다

- 중요 포인트2
  - 프록시는 메서드 오버라이딩 개념으로 동작한다.
  - 따라서 생성자나 static 메서드, 필드 값 접근에는프록시 개념이 적용될 수 없다
  - 프록시 방식을 사용하는 스프링 AOP는 
    스프링 컨테이너가 관리할 수 있는 **스프링 빈에만** AOP를 적용할수 있다.
    - > 컴파일 시점, 런타임 시점 위빙을 지원하는 경우는 new로 생성하는 객체든 뭐든 전부 aop적용가능.
    - > 당연하게도.. 아싸리 .class 바이트 코드 수정하는거니까.. 

- 그럼 aspectj가 더 기능이 많으니 이걸 spring aop대신 쓰는게 좋지 않을까? -> 중요 포인트~ 👍
    스프링이 제공하는 AOP는 프록시를 사용한다. 따라서 프록시를 통해 메서드를 실행하는 시점에만 AOP가
    적용된다. AspectJ를 사용하면 앞서 설명한 것 처럼 더 복잡하고 더 다양한 기능을 사용할 수 있다.
    그렇다면 스프링 AOP 보다는 더 기능이 많은 AspectJ를 직접 사용해서 AOP를 적용하는 것이 더 좋지
    않을까?
    AspectJ를 사용하려면 공부할 내용도 많고, 자바 관련 설정(특별한 컴파일러, AspectJ 전용 문법, 자바
    실행 옵션)도 복잡하다. 반면에 스프링 AOP는 별도의 추가 자바 설정 없이 스프링만 있으면 편리하게 AOP
    를 사용할 수 있다. 실무에서는 스프링이 제공하는 AOP 기능만 사용해도 대부문의 문제를 해결할 수 있다. 
    따라서 스프링 AOP가 제공하는 기능을 학습하는 것에 집중하자
    > aspectj mode 세팅해서 위빙에 이용할수 있는 것으로 보임
    > https://gmoon92.github.io/spring/aop/2019/05/24/aspectj-of-spring.html

- Q/A
  - 프록시 객체를 만들때 바이트코드를 조작해서 새로운 클래스를 만들어내기 때문에 
  - 런타임 시점(프록시) 위빙도 결국 바이트 코드 조작이 들어가긴함. -> 앞서 나온 cglib 같은거..


## AOP 용어 정리 (8)

pdf 참조

## 정리

## 기타

- 생각해보니 redismq에서 failover라는 어노테이션을 만들었는데,
- 이거 @Aspect의 @Around에서 asspectj expression으로 해당 어노테이션 붙은 빈을 대상으로 -> 포인트컷
- advice를 적용했던거 같음. 즉 @Around를 이용한 포인트컷에서 어노테이션을 target으로 프록시 생성이 가능하단것..
- > 맞나 확인 필요
- 스프링 AOP의 제약사항은 아래 블로그 정리가 좋네
  - https://sg-choi.tistory.com/290