# 쓰레드 로컬

## 필드 동기화 - 개발

- 개요
  - 앞선 hellotrace는 정식 버전의 로그 추적기가 아니었음
  - 따라서 이제 정식 버전의 로그 추적기를 logtrace package에 만든다.
    - > 기존 hellotrace 이용시 traceid동기화가 안되었는데 ( 그래서 method를 전부 수정함 )  
    - > 정식 버전에서는 thread local에 해당 값을 저장하려고 하나봄.. 아직은 이렇게 만들지 않음
  - FieldLogTrace라는 class를 만듬
    - 이제 직전 로그의 TraceId 는 파라미터로 전달되는 것이 아니라 FieldLogTrace 의 필드인 traceIdHolder 에 저장된다.
    - 여기서 중요한 부분은 로그를 시작할 때 호출하는 syncTraceId() 와 로그를 종료할 때 호출하는 releaseTraceId() 이다.

- 쓰레드 로컬 이란? (cpp 기준)
  - 쓰레드 별 static 영역
  - 이거 binary에서 보면 heap은 영역이 없었는데, static 영역은 있었음. 이거 라고 보면 되는듯.
  - > 그리고 이거 만들기 위한 keyword는 컴파일러 별로 다른거 같음. cpp 강좌에서는 OS별로 keyword가 다르다고 했는데. 이게 컴파일러영향인듯

## 필드 동기화 - 적용 (6)

- 개요
  - app v3에 만든 FieldLogTrace적용

- 실무
  - pdf에 아래 문구가 있음
    -  traceIdHolder 필드를 사용한 덕분에 파라미터 추가 없는 깔끔한 로그 추적기를 완성했다. 이제 실제 서비스에 배포한다고 가정해보자.
    -  > 동시성 문제
  - 면접 질문이고, 이것때문에 일년에 한번씩 문제를 겪는다고함

## 필드 동기화 - 동시성 문제 (11)

- 개요
  - 위 만든 app v3의 동시성 문제가 있음을 보임

- Q/A
  - 쓰레드 로컬 vs @RequestScope
    - 쓰레드 로컬은 자바 기능이라서 더 범용으로 사용됨
    - RequestScope는 http호출 + 스프링 기능
      - 이거 이용하면 requeset마다 bean이 생성됨

## 동시성 문제 - 예제 코드 (14)

- 개요
  - test code 예제로 동시성 문제 확인
  - 전형적인 쓰레드 동시성 문제 예제임.

- info
  - lombok을 test code에서도 사용하기 위한 gradle 세팅 있음

- 의견
  - pdf 내용 보면 좋음
    - 동시성 이슈는 지역 변수 (stack) 에서는 발생하지 않음. 각각 쓰레드가 stack을 가지니까
    - 동시성 이슈는 static 변수나 인스턴스 field(주소 싱글톤에서 자주 발생)에서 발생
    - 동시성 이슈는 값을 읽기만 해서는 발생하지 않음

## ThreadLocal - 소개 

## ThreadLocal - 예제 코드


## 기타 

- nio-8080-exec-1
  - 이거 tomcat의 스레드를 나타냄. 1번 쓰레드라는 의미. 뒤 숫자가 쓰레드 번호..

- countdownlatch
  - https://codechacha.com/ko/java-countdownlatch/
  - 다른 쓰레드 종료까지 기다리는 방법  
    - 동시성 문제 - 예제 코드 (14) 에서는 그냥 sleep을 이용함