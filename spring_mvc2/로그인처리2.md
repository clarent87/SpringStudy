# 로그인 처리2 - 필터, 인터셉터

## 서블릿 필터 - 소개

- 필터 : 서블릿 제공 기능
- 인터셉터 : 스프링 제공 기능
  
위 두개는 장단이 있어서, case마다 선택해서 써야 하나봄   

- 공통 관심사
  - AOP로 처리 되지만
  - 웹에서는 필터, 인터셉터 이용하는게 좋다. 
    - 처리로직에 url 등등의 정보가 필요한데, 필터, 인터셉터가 HttpServletRequest를 제공해줌

## 서블릿 필터 - 요청 로그 (3)

- HTTP 요청 -> WAS -> 필터 -> 서블릿 -> 컨트롤러 -> 필터
  - > 필터 호출 순서가 위와 같다고 보여짐. pdf에서는 "HTTP 요청 -> WAS -> 필터 -> 서블릿 -> 컨트롤러" 까지만 있음  
  - > 이유?  
  - > 컨트롤러의 에러 로그를 보면 필터REQUEST 로그-> errorlog -> 필터RESPONSE 로그 순으로 찍힘  
  - > 자세한건 code의 logfilter 참조

- UUID로 고객의 request를 구분햇는데. 이걸 transaction id라고도 함
- doFilter에서 요청이 처리되는 시간 체크도 할수 있다. 아래 처럼

```java
        try {
            // 시간 체크 시작
            log.info("REQUEST [{}][{}]", uuid, requestURI);
            chain.doFilter(request, response);
        } catch (Exception e) {
            throw e;
        } finally {
            // 시간 체크 종료 후. 로그 남김
            log.info("RESPONSE [{}][{}]", uuid, response);
        }
```

- 주의
  - 필터에서 chain.doFilter 호출안해주면 다음단계 진행이 안됨.
  - 즉, 필터 -> 서블릿 -> 컨트롤러 에서 서블릿 컨트롤러 호출없이 종료됨 ( 사용자는 컨트롤러에서 세팅된 응답을 받을수가 없음)

- 참고
  - URL 패턴에 대한 룰은 필터도 서블릿과 동일하다. 자세한 내용은 서블릿 URL 패턴으로 검색해보자.
- 참고
  - @ServletComponentScan @WebFilter(filterName = "logFilter", urlPatterns = "/*") 로
  - 필터 등록이 가능하지만 필터 순서 조절이 안된다. 따라서 FilterRegistrationBean 을 사용하자.

- 참고
  - 실무에서 HTTP 요청시 같은 요청의 로그에 모두 같은 식별자를 자동으로 남기는 방법은 logback mdc로 검색해보자.
  - > 현재 예시에서는 UUID로 filter에서 사용하긴 하는데. 컨트롤러에는 해당 값이 넘어가지 않으니 컨트롤러에서 찍히는 log는 요청 구분이 안됨 

## 서블릿 필터 - 인증 체크 (6)

- PatternMatchUtils 
  - > 이거 좋은듯. 
- interface default method 는 구현안해도 된다. 
- 필터 한두번 탄다고 해서 성능에 이슈는없다. 
  - DB 조회나 외부 api 호출..이런데가 성능에 이슈인 부분. 나머지는 모래알 같은 영향을 준다. 
- 필터 순서
  - Log filter (request)-> loginCheck filter(여기서 서블릿 -> 컨트롤러 갔다옴.) -> log filter (response)
    - 위 순으로 로그가 찍힘

스프링 시큐리티도 결국을 filter에서 출발하는것 ( filter를 등록하고 그런게 기본인가봄)  

- 참고
  - 필터에는 다음에 설명할 스프링 인터셉터는 제공하지 않는, 아주 강력한 기능이 있는데
  - chain.doFilter(request, response); 를 호출해서 다음 필터 또는 서블릿을 호출할 때
  -  request ,response 를 다른 객체로 바꿀 수 있다. ServletRequest , ServletResponse 를 구현한 다른 객체를
  -  만들어서 넘기면 해당 객체가 다음 필터 또는 서블릿에서 사용된다. 잘 사용하는 기능은 아니니 참고만 해두자.

## 스프링 인터셉터 - 소개

## 스프링 인터셉터 - 요청 로그

## 스프링 인터셉터 - 인증 체크

## ArgumentResolver 활용

> 핸들러 어댑터에서 핸들러 호출전에 들어가는게 ArgumentResolver.. 여기서 httpMessageConverter 호출되는거 였음

## 정리
